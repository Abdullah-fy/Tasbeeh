name: Sign Windows Executable

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish
        run: |
          dotnet publish ToastrForge.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true -o publish/win

      - name: Self-Sign the Executable
        shell: pwsh
        run: |
          $cert = New-SelfSignedCertificate `
            -Subject "CN=Abdullah Tech Solutions" `
            -Type CodeSigningCert `
            -CertStoreLocation "Cert:\CurrentUser\My"

          $pwd = ConvertTo-SecureString "ActionPassword123!" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "temp_cert.pfx" -Password $pwd

          $signtool = (Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe" `
            | Sort-Object LastWriteTime -Descending `
            | Select-Object -First 1).FullName

          & $signtool sign /fd SHA256 /f "temp_cert.pfx" /p "ActionPassword123!" `
            /tr http://timestamp.digicert.com /td SHA256 `
            "publish/win/Tasbeeh.exe"

          Remove-Item "temp_cert.pfx" -Force
